{{#each dataObjectMappings}}

CREATE OR ALTER PROCEDURE [SP_{{targetDataObject.name}}] @{{../metadataConfiguration.etlProcessAttribute}} INT
AS

--
-- Persistent Staging Area Stored Procedure for {{targetDataObject.name}} using a DIRECT wrapper.
-- This template expects a full copy of incoming data to be available in a landing area, and performs a full outer join to detects data changes.
--
-- Generated from template '150 Persistent Staging Area Stored Procedure Delta'.
--

INSERT INTO [{{lookupExtension targetDataObject.extensions "datastore"}}].[{{lookupExtension targetDataObject.extensions "location"}}].[{{targetDataObject.name}}]
(
   [{{../metadataConfiguration.etlProcessAttribute}}], 
   [{{../metadataConfiguration.loadDateTimeAttribute}}],
   [{{../metadataConfiguration.eventDateTimeAttribute}}],
   [{{../metadataConfiguration.sourceRowIdAttribute}}],
   [{{../metadataConfiguration.changeDataCaptureAttribute}}],
   [{{../metadataConfiguration.recordChecksumAttribute}}],
   {{#each dataItemMappings}}
   [{{sourceDataItems.0.name}}]{{#unless @last}},{{/unless}}
   {{/each}}
)
SELECT
   @AUDIT_TRAIL_ID AS [{{../metadataConfiguration.etlProcessAttribute}}],
   [{{../metadataConfiguration.loadDateTimeAttribute}}],
   [{{../metadataConfiguration.eventDateTimeAttribute}}],
   [{{../metadataConfiguration.sourceRowIdAttribute}}],
   [{{../metadataConfiguration.changeDataCaptureAttribute}}],
   [{{../metadataConfiguration.recordChecksumAttribute}}],
   {{#each dataItemMappings}}
   [{{targetDataItem.name}}]{{#unless @last}},{{/unless}}
   {{/each}}
   {{!-- Debugging --}}
   --[LKP_{{../metadataConfiguration.recordChecksumAttribute}}],
   --[LKP_{{../metadataConfiguration.changeDataCaptureAttribute}}],
   --[KEY_ROW_NUMBER]
FROM 
(
  SELECT
     STG.[{{../metadataConfiguration.loadDateTimeAttribute}}],
     STG.[{{../metadataConfiguration.eventDateTimeAttribute}}],
     STG.[{{../metadataConfiguration.sourceRowIdAttribute}}],
     STG.[{{../metadataConfiguration.changeDataCaptureAttribute}}],
     STG.[{{../metadataConfiguration.recordChecksumAttribute}}],
     {{#each dataItemMappings}}
     STG.[{{sourceDataItems.0.name}}],
     {{/each}}
     COALESCE(maxsub.[LKP_{{../metadataConfiguration.recordChecksumAttribute}}], 'N/A') AS [LKP_{{../metadataConfiguration.recordChecksumAttribute}}],
     COALESCE(maxsub.[LKP_{{../metadataConfiguration.changeDataCaptureAttribute}}], 'N/A') AS [LKP_{{../metadataConfiguration.changeDataCaptureAttribute}}],
     CAST(ROW_NUMBER() OVER
        (  PARTITION BY
             {{#each businessKeyDefinitions}}{{#each businessKeyComponentMappings}}STG.[{{sourceDataItems.0.name}}],
             {{/each}}{{/each}}
             STG.[{{../metadataConfiguration.sourceRowIdAttribute}}]
           ORDER BY
             {{#each businessKeyDefinitions}}{{#each businessKeyComponentMappings}}STG.[{{sourceDataItems.0.name}}],
             {{/each}}{{/each}}
             STG.[{{../metadataConfiguration.sourceRowIdAttribute}}],
             STG.[{{../metadataConfiguration.loadDateTimeAttribute}}]
      )  AS INT
    ) AS KEY_ROW_NUMBER
  FROM [{{lookupExtension sourceDataObjects.0.extensions "datastore"}}].[{{lookupExtension sourceDataObjects.0.extensions "location"}}].[{{sourceDataObjects.0.name}}] STG
  -- Prevent reprocessing
  LEFT OUTER JOIN [{{lookupExtension targetDataObject.extensions "datastore"}}].[{{lookupExtension targetDataObject.extensions "location"}}].[{{targetDataObject.name}}] HSTG
    ON
       {{#each businessKeyDefinitions}}  {{#each businessKeyComponentMappings}}
       HSTG.[{{targetDataItem.name}}] = STG.[{{sourceDataItems.0.name}}] AND{{/each}} {{/each}}
       HSTG.[{{../metadataConfiguration.sourceRowIdAttribute}}] = STG.[{{../metadataConfiguration.sourceRowIdAttribute}}] AND
       HSTG.[{{../metadataConfiguration.loadDateTimeAttribute}}] = STG.[{{../metadataConfiguration.loadDateTimeAttribute}}]
  -- max HSTG checksum
  LEFT OUTER JOIN 
  (
      SELECT {{#each businessKeyDefinitions}}  {{#each businessKeyComponentMappings}}
         A.[{{sourceDataItems.0.name}}], {{/each}} {{/each}}
         A.[{{../metadataConfiguration.sourceRowIdAttribute}}],  
         A.[{{../metadataConfiguration.recordChecksumAttribute}}] AS [LKP_{{../metadataConfiguration.recordChecksumAttribute}}],
         A.[{{../metadataConfiguration.changeDataCaptureAttribute}}] AS [LKP_{{../metadataConfiguration.changeDataCaptureAttribute}}]
      FROM [{{lookupExtension targetDataObject.extensions "datastore"}}].[{{lookupExtension targetDataObject.extensions "location"}}].[{{targetDataObject.name}}] A
      JOIN
      (
        SELECT {{#each businessKeyDefinitions}}  {{#each businessKeyComponentMappings}}
          B.[{{sourceDataItems.0.name}}], {{/each}} {{/each}}
          MAX({{../metadataConfiguration.sourceRowIdAttribute}}) AS MAX_{{../metadataConfiguration.sourceRowIdAttribute}},  
          MAX({{../metadataConfiguration.loadDateTimeAttribute}}) AS MAX_{{../metadataConfiguration.loadDateTimeAttribute}}
        FROM [{{lookupExtension targetDataObject.extensions "datastore"}}].[{{lookupExtension targetDataObject.extensions "location"}}].[{{targetDataObject.name}}] B
        GROUP BY {{#each businessKeyDefinitions}}  {{#each businessKeyComponentMappings}}
          B.[{{sourceDataItems.0.name}}]{{#unless @last}},{{/unless}}{{/each}} {{/each}}
     ) C ON         {{#each businessKeyDefinitions}}  {{#each businessKeyComponentMappings}}
         A.[{{targetDataItem.name}}] = C.[{{targetDataItem.name}}] AND{{/each}} {{/each}}
         A.[{{../metadataConfiguration.sourceRowIdAttribute}}] = C.[MAX_{{../metadataConfiguration.sourceRowIdAttribute}}] AND
         A.[{{../metadataConfiguration.loadDateTimeAttribute}}] = C.[MAX_{{../metadataConfiguration.loadDateTimeAttribute}}]
  ) maxsub ON     {{#each businessKeyDefinitions}}  {{#each businessKeyComponentMappings}}
     STG.[{{sourceDataItems.0.name}}] = maxsub.[{{targetDataItem.name}}] AND{{/each}} {{/each}}
     STG.[{{../metadataConfiguration.sourceRowIdAttribute}}] = maxsub.[{{../metadataConfiguration.sourceRowIdAttribute}}] 
  WHERE {{#each businessKeyDefinitions}}  {{#each businessKeyComponentMappings}} {{#if @first}}
     HSTG.[{{targetDataItem.name}}] IS NULL -- prevent reprocessing{{/if}}{{/each}} {{/each}}
) sub
WHERE
(
  KEY_ROW_NUMBER=1
  AND
  (
    ( {{../metadataConfiguration.recordChecksumAttribute}} != LKP_{{../metadataConfiguration.recordChecksumAttribute}} )
    -- The checksums are different
    OR
    ( [{{../metadataConfiguration.recordChecksumAttribute}}] = [LKP_{{../metadataConfiguration.recordChecksumAttribute}}] AND     
      [{{../metadataConfiguration.changeDataCaptureAttribute}}] != [LKP_{{../metadataConfiguration.changeDataCaptureAttribute}}] )
    -- The checksums are the same but the CDC is different
    -- In other words, if the hash is the same AND the CDC operation is the same then there is no change
  )
)
OR
(
  -- It's not the most recent change in the set, so the record can be inserted as-is
  KEY_ROW_NUMBER!=1
)

SELECT @@ROWCOUNT AS ROWS_INSERTED
GO

{{!--  Integration with the control framework --}}
{{#each extensions}}
{{#stringcompare key "hasControlFramework"}}
-- Integration with the control framework, module registration
EXEC [{{lookupExtension ../../extensions "controlFrameworkDataStore"}}].[{{lookupExtension ../../extensions "controlFrameworkLocation"}}].[RegisterModule]
 @ModuleCode = '150_{{../../targetDataObject.name}}'
,@ModuleAreaCode = 'PSA'
,@Executable = 'EXEC [{{lookupExtension ../../targetDataObject.extensions "datastore"}}].[{{lookupExtension ../../targetDataObject.extensions "location"}}].[SP_{{../../targetDataObject.name}}] @AUDIT_TRAIL_ID = @ModuleInstanceId'
,@ModuleDescription = 'Persistent Staging Area process for [{{../../sourceDataObjects.0.name}}]'
,@ModuleSourceDataObject = '[{{lookupExtension ../../sourceDataObjects.0.extensions "datastore"}}].[{{lookupExtension ../../sourceDataObjects.0.extensions "location"}}].[{{../../sourceDataObjects.0.name}}]'
,@ModuleTargetDataObject = '[{{lookupExtension ../../targetDataObject.extensions "datastore"}}].[{{lookupExtension ../../targetDataObject.extensions "location"}}].[{{../../targetDataObject.name}}]'

-- Run the process
--EXEC [{{lookupExtension ../../extensions "controlFrameworkDataStore"}}].[{{lookupExtension ../../extensions "controlFrameworkLocation"}}].[RunModule] @ModuleCode = '150_{{../../targetDataObject.name}}', @Debug='Y', @ModuleInstanceIdColumnName='AUDIT_TRAIL_ID'
{{/stringcompare}}{{/each}}

{{/each}}
