{{#each dataObjectMappings}}
update omd.PARAMETER set PARAMETER_VALUE_CODE='MERGE INTO {{sourceDataObjects.0.name}} AS target

USING (

SELECT 
sha1(UPPER(CAST({{#each businessKeys}}{{#each businessKeyComponentMapping}} RTRIM(IFNULL(updates.{{sourceDataItems.0.name}},''NA'')){{#unless @last}}||''|''||{{/unless}}{{/each}} {{/each}} AS STRING)))  as mergeKey
, updates.*

  FROM DL_{{targetDataObject.name}}  AS updates

  UNION ALL

  SELECT NULL as mergeKey, updates.*

  FROM DL_{{targetDataObject.name}}  AS updates

  JOIN {{sourceDataObjects.0.name}} AS target
ON sha1(UPPER(CAST({{#each businessKeys}}{{#each businessKeyComponentMapping}} RTRIM(IFNULL(updates.{{sourceDataItems.0.name}},''NA'')){{#unless @last}}||''|''||{{/unless}}{{/each}} {{/each}} AS STRING))) = sha1(UPPER(CAST({{#each businessKeys}}{{#each businessKeyComponentMapping}} RTRIM(IFNULL(target.{{sourceDataItems.0.name}},''NA'')){{#unless @last}}||''|''||{{/unless}}{{/each}} {{/each}} AS STRING))) 

  WHERE target.OMD_CURRENT_RECORD_INDICATOR = ''Y'' AND updates.OMD_HASH_DIFF <> target.OMD_HASH_DIFF

) staged_updates

ON 
sha1(UPPER(CAST({{#each businessKeys}}{{#each businessKeyComponentMapping}} RTRIM(IFNULL(target.{{sourceDataItems.0.name}},''NA'')){{#unless @last}}||''|''||{{/unless}}{{/each}} {{/each}} AS STRING))) = mergeKey


WHEN NOT MATCHED THEN  INSERT

(
 {{#each dataItemMappings}}
   {{sourceDataItems.0.name}}{{#unless @last}},{{/unless}}
   {{/each}}
,{{../metadataConfiguration.recordSourceAttribute}},{{../metadataConfiguration.etlProcessAttribute}},OMD_FILE_LOCATION,{{../metadataConfiguration.eventDateTimeAttribute}},[{{../metadataConfiguration.loadDateTimeAttribute}}],OMD_HASH_DIFF,OMD_UPDATE_MODULE_INSTANCE_ID,OMD_CURRENT_RECORD_INDICATOR,OMD_DELETED_RECORD_INDICATOR,OMD_EXPIRY_DATETIME)  

VALUES

(
 {{#each dataItemMappings}}
  staged_updates.{{sourceDataItems.0.name}}{{#unless @last}},{{/unless}}
   {{/each}}
,staged_updates.{{../metadataConfiguration.recordSourceAttribute}},staged_updates.{{../metadataConfiguration.etlProcessAttribute}},staged_updates.OMD_FILE_LOCATION,staged_updates.{{../metadataConfiguration.eventDateTimeAttribute}},staged_updates.[{{../metadataConfiguration.loadDateTimeAttribute}}],staged_updates.OMD_HASH_DIFF,''NULL'',''Y'',''N'',''9999-12-31'');' where parameter_key_code='DL_SILVER_INSERT_{{sourceDataObjects.0.name}}';
{{/each}}
