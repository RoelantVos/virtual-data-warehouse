{{#each dataObjectMappings}}
--
-- Persistent Staging Area View definition for {{targetDataObject.name}}
--

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[{{../metadataConfiguration.vdwSchemaName}}].[{{targetDataObject.name}}]') AND type in (N'V'))
DROP VIEW [{{../metadataConfiguration.vdwSchemaName}}].[{{targetDataObject.name}}]
GO

CREATE VIEW [{{../metadataConfiguration.vdwSchemaName}}].[{{targetDataObject.name}}] AS

SELECT
   {{#each dataItemMappings}}
   STG.[{{targetDataItem.name}}],
   {{/each}}
   STG.[{{../metadataConfiguration.loadDateTimeAttribute}}],
   STG.[{{../metadataConfiguration.eventDateTimeAttribute}}],
   --STG.[{{../metadataConfiguration.recordSourceAttribute}}],
   STG.[{{../metadataConfiguration.sourceRowIdAttribute}}],
   STG.[{{../metadataConfiguration.changeDataCaptureAttribute}}],
   STG.[{{../metadataConfiguration.recordChecksumAttribute}}]
FROM [{{lookupExtension sourceDataObjects.0.extensions "datastore"}}].[{{lookupExtension sourceDataObjects.0.extensions "location"}}].[{{sourceDataObjects.0.name}}] STG
LEFT OUTER JOIN -- Prevent reprocessing
  [{{lookupExtension targetDataObject.extensions "datastore"}}].[{{lookupExtension targetDataObject.extensions "location"}}].[{{targetDataObject.name}}] HSTG
  ON{{#each businessKeyDefinitions}}  {{#each businessKeyComponentMappings}}
     HSTG.[{{targetDataItem.name}}] = STG.[{{sourceDataItems.0.name}}] AND{{/each}} {{/each}}
     HSTG.[{{../metadataConfiguration.sourceRowIdAttribute}}] = STG.[{{../metadataConfiguration.sourceRowIdAttribute}}] AND
     HSTG.[{{../metadataConfiguration.loadDateTimeAttribute}}] = STG.[{{../metadataConfiguration.loadDateTimeAttribute}}]
WHERE {{#each businessKeyDefinitions}}  {{#each businessKeyComponentMappings}} {{#if @first}}
   HSTG.[{{targetDataItem.name}}] IS NULL -- prevent reprocessing{{/if}}{{/each}} {{/each}}

{{/each}}